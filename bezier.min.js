var QreatorBezier=new function(){function e(e,t){Y.fillStyle="#ffffff"
for(var r=Y.createImageData(M,T),i=0;i<r.length;i+=4)r[i]=255,r[i+1]=255,r[i+2]=255,r[i+3]=0
if(Y.putImageData(r,0,0),e.length>0)for(var a=0;M>a;a+=e[e.length-1])for(var i=0;i<e.length;i++)Y.beginPath(),Y.moveTo(a+e[i],0),Y.lineTo(a+e[i],T),Y.strokeStyle="#aaaaff",Y.stroke()
if(t.length>0)for(var n=0;T>n;n+=t[t.length-1])for(var i=0;i<t.length;i++)Y.beginPath(),Y.moveTo(0,n+t[i]),Y.lineTo(M,n+t[i]),Y.strokeStyle="#aaaaff",Y.stroke()}function t(e,t){te>=e&&$("#ausgabe").append(t+"<br>")}function r(e,t){m=1
for(var r=0;t>r;r++)m*=10
return parseInt(e*m,10)/m}function i(e,t){if(0===le.length){Q.beginPath(),Q.moveTo(e,t),W=e,V=t,K=[],Q.lineWidth=""+G,Q.strokeStyle=R,Q.lineCap="round"
for(var r=0;C*q>r;r++)K[r]=0}else{if(Q.lineTo(e,t),1===O){Q.lineWidth=""+G,Q.strokeStyle="rgba(255,200,200,1)"
var i=e,a=W
e>W&&(i=W,a=e)
var n=t,l=V
t>V&&(n=V,l=t),i-=G,a=i+G,n-=G,l+=G
for(var s=parseInt(i/(1*M/C),10),h=parseInt(a/(1*M/C),10),o=parseInt(n/(1*T/q),10),u=parseInt(l/(1*T/q),10),r=s;h>=r;r++)for(var f=o;u>=f;f++)K[f*C+r]=1
W=e,V=t}Q.stroke(),Q.beginPath(),Q.moveTo(e,t)}le.push(new d(e,t))}function a(e){if(re===!0){var t=e.targetTouches[0].pageX-D.offsetLeft-$("#rahmen")[0].offsetLeft,r=e.targetTouches[0].pageY-D.offsetTop-$("#rahmen")[0].offsetTop
i(t,r)}n()}function n(){var e=I[S]
if(ie===!0){rechtecke2=[]
for(var t=0;C*q>t;t++)1===K[t]&&rechtecke2.push(t)
if(B=ge.findeRechtecksHuelle(le),0===O)p(le),le=[],ie=!1
else if(1===O)if(null!=j[e]&&j[e].length>0){if(N=[],rechtecke2.length<E)for(var t=0;t<j[e].length;t++){j[e][t][2]=0
var r=j[e][t][1]
o(B,r)===!0&&(j[e][t][2]=1,N.push(t))}else for(var t=0;t<j[e].length;t++){j[e][t][2]=0
var r=j[e][t][1]
h(r)===!0&&(N.push(t),j[e][t][2]=1)}for(var i=Q.getImageData(0,0,M,T),t=N.length-1;t>=0;t--){for(var r=j[e][N[t]][0],a=j[e][N[t]][3],n=j[e][N[t]][4],u=s(r),f=1/u*3,v=[],c=0,y=0,d=0;1+f>d;d+=f){d>1&&(d=1)
var x=ge.evaluiere(3,r,d),k=4*(parseInt(x.y,10)*M+parseInt(x.x,10))
200===i.data[k+1]&&(v.push(c),y++),c++}if(3>c-y)j[e].splice(N[t],1)
else{for(var m=v.length-2;m>=0;m--)v[m+1]-v[m]===2&&v.splice(m+1,0,v[m]+1)
for(var b=0,$=[],m=0;m<v.length;m++)if(v[m]-b>1){var w=ge.zerlege(r,b*f,(v[m]-1)*f)
$.push(w),b=v[m]}else b=v[m]
if(v.length>0&&v[v.length-1]*f<1){var w=ge.teile(r,v[v.length-1]*f,1)[1]
$.push(w)}if($.length>0){j[e].splice(N[t],1)
for(var u=0;u<$.length;u++)j[e].splice(N[t],0,[$[u],ge.findeRechtecksHuelle($[u]),1,a,n])}}}le=[]
for(var z=Q.createImageData(M,T),t=0;t<z.length;t+=4)z[t]=255,z[t+1]=255,z[t+2]=255,z[t+3]=0
Q.putImageData(z,0,0),l(),ie=!1,g(S,0,S)}else{le=[]
for(var z=Q.createImageData(M,T),t=0;t<z.length;t+=4)z[t]=255,z[t+1]=255,z[t+2]=255,z[t+3]=0
Q.putImageData(z,0,0),ie=!1}}}function l(){for(var e=X.createImageData(M,T),t=0;t<e.length;t+=4)e[t]=255,e[t+1]=255,e[t+2]=255,e[t+3]=0
if(X.save(),rechtecke2.length<E)X.beginPath(),X.moveTo(B[0],B[1]),X.lineTo(B[2],B[1]),X.lineTo(B[2],B[3]),X.lineTo(B[0],B[3]),X.lineTo(B[0],B[1]),X.clip(),X.putImageData(e,0,0,B[0],B[1],B[2]-B[0],B[3]-B[1])
else{X.beginPath()
for(var r=M/C,i=T/q,t=0;t<rechtecke2.length;t++){var a=parseInt(rechtecke2[t]%C,10),n=parseInt(rechtecke2[t]/C,10),l=a*r,s=n*i
X.moveTo(l,s),X.lineTo(l+r,s),X.lineTo(l+r,s+i),X.lineTo(l,s+i),X.lineTo(l,s),X.putImageData(e,l,s,0,0,r,i)}X.clip()}for(var h=I[S],t=0;t<j[h].length;t++){var o=j[h][t]
if(1==o[2]){var u=o[0]
X.beginPath(),X.moveTo(u[0].x,u[0].y),X.bezierCurveTo(u[1].x,u[1].y,u[2].x,u[2].y,u[3].x,u[3].y),X.strokeStyle=j[h][4],X.lineWidth=j[h][3],X.stroke()}}X.restore()}function s(e){for(var t=0,r=e[0].x,i=e[0].y,a=1;a<e.length;a++)t+=Math.sqrt((e[a].x-r)*(e[a].x-r)+(e[a].y-i)*(e[a].y-i))
return t}function h(e){for(var t=!1,r=M/C,i=T/q,a=0;a<rechtecke2.length;a++)x=parseInt(rechtecke2[a]%q,10),y=parseInt(rechtecke2[a]/C,10),o(e,[x*r,y*i,x*r+r,y*i+i])===!0&&(t=!0,a=rechtecke2.length)
return t}function o(e,t){return!(e[0]>t[2]||e[2]<t[0]||e[1]>t[3]||e[3]<t[1])}function u(e){if(re===!0){var t=e.pageX-D.offsetLeft-$("#rahmen")[0].offsetLeft,r=e.pageY-D.offsetTop-$("#rahmen")[0].offsetTop
i(t,r)}n()}function f(e,t,r){if(t.x===r.x)return Math.abs(e.x-t.x)
var i=new d(r.x-t.x,r.y-t.y),a=new d(e.x-t.x,e.y-t.y),n=Math.sqrt(i.x*i.x+i.y*i.y),l=(a.x*i.x+a.y*i.y)/n
if(l>n){var s=new d(r.x-e.x,r.y-e.y)
return Math.sqrt(s.x*s.x+s.y*s.y)}if(0>l){var s=new d(e.x-t.x,e.y-t.y)
return Math.sqrt(s.x*s.x+s.y*s.y)}var s=new d(t.x+l*i.x/n,t.y+l*i.y/n),h=new d(s.x-e.x,s.y-e.y)
return Math.sqrt(h.x*h.x+h.y*h.y)}function v(e,t){for(var r=0,i=!0,a=1;a<e.length-1;a++){var n=f(e[a],e[0],e[e.length-1])
n>r&&(r=n,r>t&&(i=!1,a=e.length))}return i}function c(e){var t=0,r=0,i=0,a=0
t=e[0].x,r=t,i=e[0].y,a=i
for(var n=1;n<e.length;n++){var l=e[n]
l.x>r?r=l.x:l.x<t&&(t=l.x),l.y>a?a=l.y:l.y<i&&(i=l.y)}return[t,i,r,a]}function p(e){if(1===e.length){var r=e[0].x,i=e[0].y
e=[],e.push(new d(r-1,i-1)),e.push(new d(r+1,i-1)),e.push(new d(r+1,i+1)),e.push(new d(r-1,i+1))}var a=!1,n=ge.berechneEntfernung(e[0],e[e.length-1])
if(15>n){var l=c(e),s=l[0],h=l[2],o=l[1],u=l[3],f=1*(h-s)/(u-o)
if(1.5>f&&f>.8){for(var p=.5*(s+h),y=.5*(o+u),g=.25*(h-s+(u-o)),x=new d(p,y),k=!0,m=0;m<e.length;m++){var b=ge.berechneEntfernung(x,e[m])
1.3*g>b&&b>.8*g||(k=!1,m=e.length)}if(k===!0){var $=.551915024494
z=[],z.push([new d(x.x,x.y+g),new d(x.x+$*g,x.y+g),new d(x.x+g,x.y+g*$),new d(x.x+g,x.y)]),z.push([new d(x.x+g,x.y),new d(x.x+g,x.y-$*g),new d(x.x+$*g,x.y-g),new d(x.x,x.y-g)]),z.push([new d(x.x,x.y-g),new d(x.x-$*g,x.y-g),new d(x.x-g,x.y-g*$),new d(x.x-g,x.y)]),z.push([new d(x.x-g,x.y),new d(x.x-g,x.y+$*g),new d(x.x-$*g,x.y+g),new d(x.x,x.y+g)]),a=!0}}}if(a===!1){var w=parseInt(n/20,10),z=[]
if(v(e,w)===!0){var D=e[0],C=e[e.length-1],q=C.x-D.x,A=C.y-D.y
if(0!==A){var _=1*A/q
if(Math.abs(_)<F){var P=(D.y+C.y)/2
D.y=P,C.y=P}}else if(0!==q){var _=1*q/A
if(Math.abs(_)<F){var P=(D.x+C.x)/2
D.x=P,C.x=P}}z=[[D,ge.addiere(D,ge.multipliziereMitSkalar(ge.subtrahiere(C,D),1/3)),ge.addiere(D,ge.multipliziereMitSkalar(ge.subtrahiere(C,D),2/3)),C]],a=!0}}if(a===!1&&(ge.initialisiere(e,H),z=ge.approximiere()),e.length>0){for(var E=Q.createImageData(M,T),m=0;m<E.length;m+=4)E[m]=255,E[m+1]=255,E[m+2]=255,E[m+3]=0
Q.putImageData(E,0,0)}for(var m=0;m<z.length;m++){var K=z[m]
1===K.length?(X.beginPath(),X.fillStyle=R,X.fillRect(K[0].x,K[0].y,1,1)):4===K.length&&(X.beginPath(),X.moveTo(K[0].x,K[0].y),X.strokeStyle=R,X.lineCap="round",X.lineWidth=""+G,X.bezierCurveTo(K[1].x,K[1].y,K[2].x,K[2].y,K[3].x,K[3].y),t(3,K[0].x+"/"+K[0].y+","+K[1].x+"/"+K[1].y+","+K[2].x+"/"+K[2].y+","+K[3].x+"/"+K[3].y),X.stroke(),j[I[S]].push([K,ge.findeRechtecksHuelle(K),0,G,R]))}if(te>2)for(var m=0;m<e.length;m++){var r=e[m].x,i=e[m].y
Q.fillStyle="#ff0000",Q.fillRect(r-2,i-2,5,5)}}function g(e,t,r){for(var i=Q.createImageData(M,T),a=0;a<i.length;a+=4)i[a]=255,i[a+1]=255,i[a+2]=255,i[a+3]=0
Q.putImageData(i,0,0),e>=t&&X.putImageData(i,0,0),r>e&&Z.putImageData(i,0,0)
for(var a=t;r>=a;a++){var n=X
a>e&&(n=Z)
var l=I[a]
if(1==z[a]&&null!=j[l])for(var s=0;s<j[l].length;s++){var h=j[l][s][0]
n.beginPath(),n.moveTo(h[0].x,h[0].y),n.strokeStyle=j[l][s][4],n.lineCap="round",n.lineWidth=""+j[l][s][3],n.bezierCurveTo(h[1].x,h[1].y,h[2].x,h[2].y,h[3].x,h[3].y),n.stroke()}}}function d(e,t){this.x=e,this.y=t}for(var k,b,w,S,z,I,D,M,T,F,C,q,A,_,P,R,E,K,N,G,H,S,L,B,W,V,O,Q,X,Y,Z,j,J,U,ee,te,re,ie,ae,ne,le,se,he,oe,ue,fe,k=["#000000","#FF0000","#0000FF","#ffff00","#008000","#FFA500","#A52A2A","#800000","#808000","#808080","#cccccc","#FFFFFF","#0000A0","#ADD8E6","#800080","#00FF00","#00FFFF","#FF00FF"],b="",ve=0;ve<k.length;ve++){var ce="<button class='farbe' farbe='"+k[ve]+"' style='background: "+k[ve]+";' value='Farbe' nr='"+ve+"'><span style='color: "+k[ve]+"'>PP</span></button>"
b+=ce}var w=[2,2.5,3,3.5,4,6,8,10,12,14,16,18,20,30,40,50]
b+="<br>"
for(var ve=0;ve<w.length;ve++)b+="<button class='dicke' dicke='"+w[ve]+"'  value='D"+w[ve]+"' nr='"+ve+"'>"+w[ve]+"</button> "
var pe=[0,1,2,3,4,5,6,7,8,9],z=[1,1,1,1,1,1,1,1,1,1],I=[0,1,2,3,4,5,6,7,8,9]
b+="<br>"
for(var ve=0;ve<pe.length;ve++)b+="<button class='layer' layer='"+pe[ve]+"' >"+pe[ve]+"</button><input type='checkbox' name='layer' id='checkbox_"+ve+"' value='"+ve+"' class='check' checked='checked'></input>"
var ye=this
this.init=function(t,r,i){function n(){0==O?($(".dicke").removeClass("aktiv"),$("[dicke='"+w[P]+"']").addClass("aktiv"),$(".layer").removeClass("aktiv"),$("[layer='"+I[S]+"']").addClass("aktiv"),$(".farbe").removeClass("aktiv"),$("[farbe='"+k[fe]+"']").addClass("aktiv"),$("#radierer").removeClass("aktiv"),$("#stift").addClass("aktiv")):($(".dicke").removeClass("aktiv"),$("[dicke='"+w[ue]+"']").addClass("aktiv"),$(".layer").removeClass("aktiv"),$("[layer='"+I[S]+"']").addClass("aktiv"),$(".farbe").removeClass("aktiv"),$("#radierer").addClass("aktiv"),$("#stift").removeClass("aktiv"))}M=r,T=i,oe=t,$(t).html("<div id='rahmen' style='position: relative;'> <canvas id='layer0' width='"+M+"' height='"+T+"' style='z-index: 0;'></canvas> <canvas id='layer1'  width='"+M+"' height='"+T+"' style='position: absolute; left: 0; top: 0; z-index: 1;'></canvas><canvas id='layer2' width='"+M+"' height='"+T+"' style='position: absolute; left: 0; top: 0; z-index: 2;'></canvas> <canvas id='layer3'  width='"+M+"' height='"+T+"' style='position: absolute; left: 0; top: 0; z-index: 3;'></canvas></div><div>"+b+"</div><div id='knoepfe'> <input type='button' class='holen knopf' b='Stift' id='stift' value='Stift'/><input type='button' class='holen knopf' b='Radierer' id='radierer' value='Radierer'/><input type='button' class='holen knopf' b='Raster ändern' id='raster' value='Raster' /><input type='button' class='holen knopf' b='Alles löschen' id='loeschen' value='Alles löschen' /><input type='button' class='holen knopf' b='Aktive Ebene löschen' id='loeschenAktiv' value='Aktive Ebene löschen' /></div><div id='ausgabe'></div><div id='info' ></div>"),$(t).append("<div id='qreator_svgbild'></div>"),Q=$("#layer2")[0].getContext("2d"),Q.strokeStyle="#ff0000",D=$("#layer3")[0],F=.01,C=5,q=5,A=[[[],[]],[[30],[30]],[[],[60]],[[],[60,74,88,102,116]]],_=0,P=2.5,R="#000000",E=2,K=[],rechtecke2=[],N=[],G=2.5,ue=13,P=1,fe=0,H=1.3,S=2,L=1,B=[],W=0,V=0,O=0,X=$("#layer1")[0].getContext("2d"),Y=$("#layer0")[0].getContext("2d"),Z=$("#layer3")[0].getContext("2d"),j=[]
for(var l=0;l<I.length;l++)j[l]=[]
J=!1,U=!1,ee=!1,te=0,re=!1,ie=!1,ae=[],ne=[],le=[],se=0,he=0,D.ontouchstart=function(e){e.preventDefault(),le=[],re=!0,ee=!0,U=!1,a(e)},D.ontouchmove=function(e){e.preventDefault(),ee===!0&&1==re&&a(e)},D.ontouchend=function(e){e.preventDefault(),ee===!0&&(ie=!0,re=!1,ee=!1,a(e))},D.onmousedown=function(e){e.preventDefault(),le=[],re=!0,U=!0,ee=!1,u(e)},D.onmousemove=function(e){e.preventDefault(),U===!0&&u(e)},D.onmouseup=function(e){e.preventDefault(),U===!0&&(ie=!0,re=!1,U=!1,u(e))},$("#tbutton").click(function(e){e.preventDefault()
var t=$("#svgText").val()
ye.loadSVG(t)}),$("#download").click(function(e){e.preventDefault()
var t=$("html").html()
window.open("data:text/csv,"+t)}),$(".farbe").click(function(e){e.preventDefault(),R=$(this).attr("farbe"),fe=parseInt($(this).attr("nr")),O=0,G=w[P],n()}),$(".dicke").click(function(e){e.preventDefault(),0==O?P=parseInt($(this).attr("nr")):ue=parseInt($(this).attr("nr")),G=parseInt($(this).attr("dicke")),n()}),$(".layer").click(function(e){e.preventDefault()
var t=parseInt($(this).attr("layer"))
1==z[t]&&(S=t,null==j[S]&&(j[S]=[]),g(I[S],0,I.length-1)),n()}),$(".check").click(function(e){var t=0
1==$(this).prop("checked")&&(t=1),z[parseInt($(this).attr("value"))]=t,g(I[S],0,I.length-1),n()}),$("#radierer").click(function(e){e.preventDefault(),O=1,G=w[ue],n()}),$("#stift").click(function(){G=w[P],O=0,n()}),$("#raster").click(function(t){t.preventDefault(),_=(_+1)%4,e(A[_][0],A[_][1])}),$("#loeschenAktiv").click(function(e){e.preventDefault()
for(var t=X.createImageData(M,T),r=0;r<t.length;r+=4)t[r]=255,t[r+1]=255,t[r+2]=255,t[r+3]=0
X.putImageData(t,0,0),j[I[S]]=[],g(S,0,S)}),$("#loeschen").click(function(e){e.preventDefault()
for(var t=X.createImageData(M,T),r=0;r<t.length;r+=4)t[r]=255,t[r+1]=255,t[r+2]=255,t[r+3]=0
X.putImageData(t,0,0),Z.putImageData(t,0,0)
for(var r=0;r<I.length;r++)j[r]=[]}),$("#knopf").click(function(e){e.preventDefault(),QreatorBezier.showSVG()}),n()},this.showSVG=function(e){var t="",i=0
$("#qreator_svgbild").html("<svg  width='"+M+"' height='"+T+"' id='qreator_svgbild2' class='qreator_svg'><g fill='none' stroke-linecap='round' id='global'></g>")
for(var a=0;a<I.length;a++){var n=I[a]
if(null!=j[n]&&j[n].length>0){var l=""
0==z[a]&&(l="visibility='hidden'"),$("#qreator_svgbild2 #global").append("<g id='layer_"+n+"' "+l+"></g>")
for(var s="",h=j[n][0][0][3],o="",u="",f="",v="",c="<path d='",p=0;p<j[n].length;p++){var y=j[n][p][0],g=j[n][p][4],d=j[n][p][3];(g!=o||d!=u)&&(f=" stroke='"+g+"'",o=g,f+=" stroke-width='"+d+"'",u=d),f.length>0&&(s.length>0&&(t+=c+s+"' "+v+" />",h={x:-1,y:-1},s=""),v=f,f=""),s+=p>0&&y[0].x===h.x&&y[0].y===h.y?" c"+r(y[1].x-y[0].x,L)+","+r(y[1].y-y[0].y,L)+" "+r(y[2].x-y[0].x,L)+","+r(y[2].y-y[0].y,L)+" "+r(y[3].x-y[0].x,L)+","+r(y[3].y-y[0].y,L):" M"+r(y[0].x,L)+","+r(y[0].y,L)+" c"+r(y[1].x-y[0].x,L)+","+r(y[1].y-y[0].y,L)+" "+r(y[2].x-y[0].x,L)+","+r(y[2].y-y[0].y,L)+" "+r(y[3].x-y[0].x,L)+","+r(y[3].y-y[0].y,L),h=j[n][p][0][3],s.length>2e3&&(t+="<path d='"+s+"' "+v+" />",o="",g="",h={x:-1,y:-1},s="",t.length>1e4&&($("#qreator_svgbild2 #global #layer_"+n).append(t),i+=t.length,t=""),o="",u="")}s.length>0&&(t+="<path d='"+s+"' "+v+" />"),t.length>0&&($("#qreator_svgbild2 #global #layer_"+n).append(t),i+=t.length,t="")}}$("#qreator_svgbild #qreator_svgbild2").removeAttr("id"),$(oe).html("<div class='"+e+"' >"+$("#qreator_svgbild").html()+"</div>")},this.loadSVG=function(e){for(var t=0,r=0;r<z.length;r++)z[r]=1
$(e).find("#global").find("g").each(function(){var e=parseInt($(this).attr("id").split("_")[1])
j[e]=[],t++,"hidden"==$(this).attr("visibility")&&(z[e]=0),$(this).find("path").each(function(){for(var t=$(this).attr("stroke"),r=parseInt($(this).attr("stroke-width")),i=$(this).attr("d"),a=i.trim(),n=a.split("M"),l=0;l<n.length;l++)if(""!=n[l]){var s=n[l].split("c"),h=s[0].split(","),o=[],u=new d(parseFloat(h[0]),parseFloat(h[1]))
o.push(u)
for(var f=1;f<s.length;f++){var v=s[f].split(" ")
if(v.length>=3)for(var c=0;3>c;c++)h=v[c].split(","),u=new d(parseFloat(h[0])+o[0].x,parseFloat(h[1])+o[0].y),o.push(u)
j[e].push([o,ge.findeRechtecksHuelle(o),0,r,t]),4==o.length&&(u=new d(o[3].x,o[3].y),o=[],o.push(u))}}})})
var i=[],a=[]
10>t&&(t=10)
for(var r=0;t>r;r++)i[r]=r,a[r]=r,null==z[r]&&(z[r]=1)
for(var r=0;r<z.length;r++)$("#checkbox_"+r).prop("checked",z[r])
g(0,0,t-1)}
var ge={initialisiere:function(e,t){this.ergebnis=[],this.epsilon=1e-6,this.TOLERANZ=1e-7
var r=null
this.fehler=t,this.punkte=[]
for(var i=0;i<e.length;i++){var a=e[i]
r&&a.x==r.x&&a.y==r.y||(this.punkte.push(a),r=a)}this.fehler=t},findeRechtecksHuelle:function(e){for(var t=e[0].x,r=t,i=e[0].y,a=i,n=1;n<e.length;n++)t>e[n].x?t=e[n].x:r<e[n].x&&(r=e[n].x),i>e[n].y?i=e[n].y:a<e[n].y&&(a=e[n].y)
return[t-G,i-G,r+G,a+G]},findeKonvexeHuelle:function(e){function t(e,t){var r=e.x-t.x,i=e.y-t.y
return r*r+i*i}function r(e,r,i){var a=(r.x-e.x)*(i.y-e.y)-(i.x-e.x)*(r.y-e.y)
return a>0?!0:0>a?!1:t(e,i)>t(e,r)}for(var i=e.length,a=[],n=0,l=1;l!=i;l++)e[l].y<e[n].y&&(n=l)
var s=e[n],h=null
do{a.push(s),h=e[0]
for(var l=1;l!=i;l++)(s.x===h.x&&s.y===h.y||r(s,h,e[l]))&&(h=e[l])
s=h}while(h.x!==a[0].x||h.y!==a[0].y)
return a},parametrisiereKurve:function(e,t){for(var r=[0],i=e+1;t>=i;i++)r[i-e]=r[i-e-1]+this.berechneEntfernungIndex(i,i-1)
for(var a=r[r.length-1],n=0;n<r.length;n++)r[n]/=a
return r},berechneEntfernungIndex:function(e,t){var r=this.punkte[e].x-this.punkte[t].x,i=this.punkte[e].y-this.punkte[t].y
return Math.sqrt(r*r+i*i)},berechneEntfernung:function(e,t){var r=e.x-t.x,i=e.y-t.y
return Math.sqrt(r*r+i*i)},normiere:function(e){var t=Math.sqrt(e.x*e.x+e.y*e.y)
return 0!==t&&(e.x=e.x/t,e.y=e.y/t),e},multipliziereSkalar:function(e,t){return e.x*t.x+e.y*t.y},multipliziereMitSkalar:function(e,t){return{x:e.x*t,y:e.y*t}},addiere:function(e,t){return{x:e.x+t.x,y:e.y+t.y}},subtrahiere:function(e,t){return{x:e.x-t.x,y:e.y-t.y}},approximiere:function(){var e=this.punkte,r=e.length
return this.ergebnis=r>0?[[e[0]]]:[],r>1&&(t(2,"Anzahl der Punkte: "+r),this.approximiereKubisch(0,r-1,this.normiere(this.subtrahiere(e[1],e[0])),this.normiere(this.subtrahiere(e[r-2],e[r-1])))),this.ergebnis},approximiereKubisch:function(e,r,i,a){if(r-e===1){var n=this.punkte[e],l=this.punkte[r],s=this.berechneEntfernung(n,l)/3
return void this.ergebnis.push([n,this.addiere(n,this.multipliziereMitSkalar(this.normiere(i),s)),this.addiere(l,this.multipliziereMitSkalar(this.normiere(a),s)),l])}for(var h,o=this.parametrisiereKurve(e,r),u=Math.max(this.fehler,this.fehler*this.fehler),f=0;4>=f;f++){var v=this.findeBezierNaeherung(e,r,o,i,a),c=[]
c.push(v)
var p=this.findeGroesstenFehler(e,r,v,o)
if(p.error<this.fehler)return void this.ergebnis.push(v)
if(h=p.index,p.error>=u){t(3,"Maximaler Fehler: "+u+", gemessener Fehler: "+p.error)
break}o=this.reparametrisiere(e,r,o,v),u=p.error}var y=this.subtrahiere(this.punkte[h-1],this.punkte[h]),g=this.subtrahiere(this.punkte[h],this.punkte[h+1]),d=this.normiere(this.multipliziereMitSkalar(this.addiere(y,g),.5))
this.approximiereKubisch(e,h,i,d),this.approximiereKubisch(h,r,this.multipliziereMitSkalar(d,-1),a)},findeBezierNaeherung:function(e,r,i,a,n){t(3,"findeBezierNäherung: "+e+" "+r)
for(var l=this.epsilon,s=this.punkte[e],h=this.punkte[r],o=[[0,0],[0,0]],u=[0,0],f=r-e+1,v=0;f>v;v++){var c=i[v],p=1-c,y=3*c*p,g=p*p*p,d=y*p,x=y*c,k=c*c*c,m=this.multipliziereMitSkalar(this.normiere(a),d),b=this.multipliziereMitSkalar(this.normiere(n),x),$=this.subtrahiere(this.subtrahiere(this.punkte[e+v],this.multipliziereMitSkalar(s,g+d)),this.multipliziereMitSkalar(h,x+k))
o[0][0]+=this.multipliziereSkalar(m,m),o[0][1]+=this.multipliziereSkalar(m,b),o[1][0]=o[0][1],o[1][1]+=this.multipliziereSkalar(b,b),u[0]+=this.multipliziereSkalar(m,$),u[1]+=this.multipliziereSkalar(b,$)}var w,S,z=o[0][0]*o[1][1]-o[1][0]*o[0][1]
if(Math.abs(z)>l){var I=o[0][0]*u[1]-o[1][0]*u[0],D=u[0]*o[1][1]-u[1]*o[0][1]
w=D/z,S=I/z}else{var M=o[0][0]+o[0][1],T=o[1][0]+o[1][1]
w=S=Math.abs(M)>l?u[0]/M:Math.abs(T)>l?u[1]/T:0}var F=this.berechneEntfernung(s,h)
return l*=F,(l>w||l>S)&&(w=S=F/3),[s,this.addiere(s,this.multipliziereMitSkalar(this.normiere(a),w)),this.addiere(h,this.multipliziereMitSkalar(this.normiere(n),S)),h]},evaluiere:function(e,t,r){for(var i=t.slice(),a=1;e>=a;a++)for(var n=0;e-a>=n;n++)i[n]=this.addiere(this.multipliziereMitSkalar(i[n],1-r),this.multipliziereMitSkalar(i[n+1],r))
return i[0]},teile:function(e,t){for(var r=e.slice(),i=[],a=1;3>=a;a++)for(var n=0;3-a>=n;n++)r[n]=this.addiere(this.multipliziereMitSkalar(r[n],1-t),this.multipliziereMitSkalar(r[n+1],t)),i.push(r[n])
return[[e[0],i[0],i[3],i[5]],[i[5],i[4],i[2],e[3]]]},zerlege:function(e,t,r){var i=this.teile(e,t)[1]
return this.teile(i,(r-t)/(1-t))[0]},findeGroesstenFehler:function(e,t,r,i){for(var a=Math.floor((t-e+1)/2),n=0,l=e+1;t>l;l++){var s=this.evaluiere(3,r,i[l-e]),h=this.subtrahiere(s,this.punkte[l]),o=h.x*h.x+h.y*h.y
o>=n&&(n=o,a=l)}return{error:n,index:a}},reparametrisiere:function(e,t,r,i){for(var a=e;t>=a;a++)r[a-e]=this.findeNullstelle(i,this.punkte[a],r[a-e])
return r},findeNullstelle:function(e,t,r){for(var i=[],a=[],n=0;2>=n;n++)i[n]=this.multipliziereMitSkalar(this.subtrahiere(e[n+1],e[n]),3)
for(var n=0;1>=n;n++)a[n]=this.multipliziereMitSkalar(this.subtrahiere(i[n+1],i[n]),2)
var l=this.evaluiere(3,e,r),s=this.evaluiere(2,i,r),h=this.evaluiere(1,a,r),o=this.subtrahiere(l,t),u=this.multipliziereSkalar(s,s)+this.multipliziereSkalar(o,h)
return Math.abs(u)<this.TOLERANZ?r:r-this.multipliziereSkalar(o,s)/u}}}
